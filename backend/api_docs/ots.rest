# ==============================================================================
# LOGITRACK - API DE ORDENS DE TRANSPORTE (VERS√ÉO ATUALIZADA)
# ==============================================================================
# 
# üìã INSTRU√á√ïES:
# 1. Instale a extens√£o "REST Client" no VS Code
# 2. Execute cada requisi√ß√£o clicando em "Send Request" acima de cada ###
# 3. IMPORTANTE: Execute login primeiro para obter tokens
# 4. Substitua os tokens nos headers Authorization
#
# üéØ ORDEM RECOMENDADA PARA TESTES:
# 1. Fazer login para obter tokens
# 2. Criar uma OT
# 3. Listar OTs
# 4. Ver detalhes da OT
# 5. Atualizar status
# 6. Testar transfer√™ncia com aceita√ß√£o
# 7. Finalizar OT
#
# ==============================================================================

# VARI√ÅVEIS GLOBAIS (atualize conforme necess√°rio)
@baseURL = http://localhost:8000
@authURL = {{baseURL}}/api/auth
@otsURL = {{baseURL}}/api/ots

# Vari√°veis para tokens (cole ap√≥s fazer login)
@accessTokenMotorista1 = 
@accessTokenMotorista2 = 
@accessTokenLogistica = 
@refreshToken = 

# Vari√°veis de teste din√¢micas
@otId = 
@transferenciaId = 

# ==============================================================================
# üîê 1. AUTENTICA√á√ÉO INICIAL (OBRIGAT√ìRIO)
# ==============================================================================

### 1.1 Login Motorista 1 (Carlos)
POST {{authURL}}/login/
Content-Type: application/json

{
    "email": "carlos@email.com",
    "password": "senha123456"
}

# üö® COPIE o access_token da resposta para @accessTokenMotorista1

### 1.2 Login Motorista 2 (Ant√¥nio) 
POST {{authURL}}/login/
Content-Type: application/json

{
    "email": "antonio@email.com",
    "password": "senha123456"
}

# üö® COPIE o access_token da resposta para @accessTokenMotorista2

### 1.3 Login Log√≠stica
POST {{authURL}}/login/
Content-Type: application/json

{
    "email": "logistica@empresa.com",
    "password": "senha123456"
}

# üö® COPIE o access_token da resposta para @accessTokenLogistica

# ==============================================================================
# üè† 2. VERIFICA√á√ÉO INICIAL
# ==============================================================================

### 2.1 Verificar endpoints dispon√≠veis
GET {{otsURL}}/endpoints/
Content-Type: application/json

# Esperado: Lista completa de todos os endpoints de OT

### 2.2 Verificar se API est√° funcionando
GET {{baseURL}}
Content-Type: application/json

# ==============================================================================
# üöö 3. CRUD B√ÅSICO - ORDENS DE TRANSPORTE
# ==============================================================================

### 3.1 Criar nova OT (Motorista Carlos)
POST {{otsURL}}/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

{
    "cliente_nome": "Distribuidora ABC Ltda",
    "endereco_entrega": "Rua Industrial, 500 - Distrito Industrial",
    "cidade_entrega": "Campinas",
    "observacoes": "Carregamento urgente - 25 pallets",
    "latitude_origem": -23.5505,
    "longitude_origem": -46.6333,
    "endereco_origem": "CD S√£o Paulo - Vila Ol√≠mpia"
}

# üö® COPIE o ID da OT criada para @otId
# Esperado:
# - Status 201 Created
# - OT criada com n√∫mero autom√°tico
# - Status inicial: INICIADA
# - Motorista criador = motorista atual = Carlos

### 3.2 Listar OTs do motorista logado
GET {{otsURL}}/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

# Esperado:
# - Status 200 OK
# - Lista das OTs do Carlos
# - Estat√≠sticas por status

### 3.3 Ver detalhes da OT criada
GET {{otsURL}}/{{otId}}/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

# üö® SUBSTITUA {{otId}} pelo ID real da OT
# Esperado:
# - Status 200 OK
# - Dados completos da OT
# - Timeline de atualiza√ß√µes

### 3.4 Tentar ver OT de outro motorista (deve dar erro)
GET {{otsURL}}/{{otId}}/
Authorization: Bearer {{accessTokenMotorista2}}
Content-Type: application/json

# Esperado:
# - Status 403 Forbidden
# - Motorista 2 n√£o pode ver OT do Motorista 1

# ==============================================================================
# üîÑ 4. FLUXO DE STATUS - SIMULA√á√ÉO REAL
# ==============================================================================

### 4.1 Iniciar carregamento
PATCH {{otsURL}}/{{otId}}/status/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

{
    "status": "EM_CARREGAMENTO",
    "observacao": "Iniciando carregamento no CD - Equipe preparando 25 pallets"
}

# Esperado:
# - Status 200 OK
# - Status atualizado
# - Registro de atualiza√ß√£o criado

### 4.2 Sair em tr√¢nsito
PATCH {{otsURL}}/{{otId}}/status/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

{
    "status": "EM_TRANSITO",
    "observacao": "Saindo do CD - ETA cliente: 14h30. Rota via Anhanguera"
}

### 4.3 Testar transi√ß√£o inv√°lida (deve dar erro)
PATCH {{otsURL}}/{{otId}}/status/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

{
    "status": "INICIADA"
}

# Esperado:
# - Status 400 Bad Request
# - Erro: "N√£o √© poss√≠vel transicionar de Em Tr√¢nsito para Iniciada"

# ==============================================================================
# üîÑ 5. SISTEMA DE TRANSFER√äNCIA COM ACEITA√á√ÉO
# ==============================================================================

### 5.1 Carlos transfere OT para Ant√¥nio (aguarda aceita√ß√£o)
POST {{otsURL}}/{{otId}}/transferir/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

{
    "motorista_destino_id": 2,
    "motivo": "Problema mec√¢nico no ve√≠culo - transferindo para van",
    "latitude": -23.5489,
    "longitude": -46.6388,
    "endereco": "Rod. Anhanguera km 20 - Posto Shell"
}

# üö® SUBSTITUA "2" pelo ID real do Ant√¥nio
# üö® COPIE o ID da transfer√™ncia para @transferenciaId
# Esperado:
# - Status 201 Created
# - Status: AGUARDANDO_ACEITACAO
# - Motorista atual ainda √© Carlos at√© Ant√¥nio aceitar

### 5.2 Ant√¥nio verifica suas transfer√™ncias pendentes
GET {{otsURL}}/transferencias/minhas/
Authorization: Bearer {{accessTokenMotorista2}}
Content-Type: application/json

# Esperado:
# - Lista de transfer√™ncias que aguardam a√ß√£o do Ant√¥nio
# - Categoriza√ß√£o: para_aceitar, aguardando_aprovacao, etc.

### 5.3 Ant√¥nio aceita a transfer√™ncia
POST {{otsURL}}/transferencias/{{transferenciaId}}/aceitar/
Authorization: Bearer {{accessTokenMotorista2}}
Content-Type: application/json

{
    "observacao": "Aceito a transfer√™ncia. J√° estou a caminho do local para assumir a carga."
}

# üö® SUBSTITUA {{transferenciaId}} pelo ID real
# Esperado:
# - Status 200 OK
# - Transfer√™ncia aprovada
# - Motorista atual da OT agora √© Ant√¥nio

### 5.4 Verificar que OT agora pertence ao Ant√¥nio
GET {{otsURL}}/{{otId}}/
Authorization: Bearer {{accessTokenMotorista2}}
Content-Type: application/json

# Esperado:
# - Status 200 OK
# - motorista_atual agora √© Ant√¥nio
# - Timeline mostra a transfer√™ncia

### 5.5 Carlos tenta acessar OT transferida (deve dar erro)
GET {{otsURL}}/{{otId}}/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

# Esperado:
# - Status 403 Forbidden
# - Carlos n√£o pode mais acessar ap√≥s transferir

# ==============================================================================
# üîÑ 7. SISTEMA DE APROVA√á√ÉO LOG√çSTICA
# ==============================================================================

### 7.1 Log√≠stica verifica transfer√™ncias pendentes
GET {{otsURL}}/transferencias/logistica/
Authorization: Bearer {{accessTokenLogistica}}
Content-Type: application/json

# Esperado:
# - Lista de transfer√™ncias com status PENDENTE
# - Que aguardam aprova√ß√£o da log√≠stica

### 7.2 Log√≠stica aprova transfer√™ncia pendente
POST {{otsURL}}/transferencias/{{transferenciaId}}/aprovar/
Authorization: Bearer {{accessTokenLogistica}}
Content-Type: application/json

{
    "observacao": "Transfer√™ncia aprovada - Solicita√ß√£o v√°lida e motorista dispon√≠vel"
}

# Esperado:
# - Status 200 OK
# - Transfer√™ncia aprovada
# - Motorista atual da OT atualizado
# - Timeline registrada

### 7.3 Criar nova transfer√™ncia para testar rejei√ß√£o
POST {{otsURL}}/{{otId}}/transferir/
Authorization: Bearer {{accessTokenMotorista2}}
Content-Type: application/json

{
    "motorista_destino_id": 3,
    "motivo": "Teste de rejei√ß√£o pela log√≠stica"
}

# SALVE o ID da nova transfer√™ncia como @transferenciaRejeicaoId

### 7.4 Log√≠stica rejeita transfer√™ncia
POST {{otsURL}}/NEW_TRANSFER_ID/rejeitar/
Authorization: Bearer {{accessTokenLogistica}}
Content-Type: application/json

{
    "observacao": "Transfer√™ncia rejeitada - Motorista destino j√° possui muitas OTs em andamento"
}

# Esperado:
# - Status 200 OK
# - Transfer√™ncia rejeitada
# - OT continua com motorista original

### 6.1 Criar segunda OT para testar recusa
POST {{otsURL}}/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

{
    "cliente_nome": "Supermercado XYZ",
    "endereco_entrega": "Av. Paulista, 1000 - Bela Vista", 
    "cidade_entrega": "S√£o Paulo",
    "observacoes": "Entrega expressa - Centro de SP"
}

# SALVE o novo ID como @otId2

### 6.2 Carlos tenta transferir para Ant√¥nio novamente
POST {{otsURL}}/NEW_OT_ID/transferir/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

{
    "motorista_destino_id": 2,
    "motivo": "Teste de recusa de transfer√™ncia"
}

# SALVE o ID da transfer√™ncia como @transferenciaId2

### 6.3 Ant√¥nio recusa a transfer√™ncia
POST {{otsURL}}/transferencias/NEW_TRANSFER_ID/recusar/
Authorization: Bearer {{accessTokenMotorista2}}
Content-Type: application/json

{
    "observacao": "N√£o posso aceitar - j√° estou com outra OT em andamento"
}

# Esperado:
# - Status 200 OK
# - Transfer√™ncia rejeitada
# - OT continua com Carlos

# ==============================================================================
# üîÑ 8. TRANSFER√äNCIA VIA LOG√çSTICA (APROVA√á√ÉO DIRETA)
# ==============================================================================

### 8.1 Log√≠stica transfere OT diretamente
POST {{otsURL}}/{{otId}}/transferir/
Authorization: Bearer {{accessTokenLogistica}}
Content-Type: application/json

{
    "motorista_destino_id": 1,
    "motivo": "Reagendamento por solicita√ß√£o do cliente - retorna para Carlos"
}

# Esperado:
# - Status 201 Created
# - Status: APROVADA (sem aguardar aceita√ß√£o)
# - Transfer√™ncia efetivada imediatamente

# ==============================================================================
# üìé 9. UPLOAD DE DOCUMENTOS
# ==============================================================================

### 8.1 Upload de canhoto (simular com curl)
# POST {{otsURL}}/{{otId}}/arquivos/
# Authorization: Bearer {{accessTokenMotorista2}}
# Content-Type: multipart/form-data

# Use este comando curl para testar upload:
# curl -X POST http://localhost:8000/api/ots/{ID}/arquivos/ \
#   -H "Authorization: Bearer SEU_TOKEN" \
#   -F "arquivo=@canhoto.jpg" \
#   -F "tipo=CANHOTO" \
#   -F "descricao=Canhoto assinado pelo cliente"

# ==============================================================================
# üèÅ 9. FINALIZA√á√ÉO DA OT
# ==============================================================================

### 9.1 Ant√¥nio finaliza a entrega
POST {{otsURL}}/{{otId}}/finalizar/
Authorization: Bearer {{accessTokenMotorista2}}
Content-Type: application/json

{
    "observacoes_entrega": "Entrega realizada com sucesso. 25 pallets conferidos e aceitos pelo Sr. Jo√£o (gerente). Sem avarias.",
    "latitude_entrega": -22.9068,
    "longitude_entrega": -47.0626,
    "endereco_entrega_real": "Distribuidora ABC - Dock 3 - Portaria Principal"
}

# Esperado:
# - Status 200 OK
# - OT finalizada como ENTREGUE
# - data_finalizacao preenchida
# - OT n√£o pode mais ser editada

### 9.2 Tentar editar OT finalizada (deve dar erro)
PATCH {{otsURL}}/{{otId}}/status/
Authorization: Bearer {{accessTokenMotorista2}}
Content-Type: application/json

{
    "status": "EM_TRANSITO"
}

# Esperado:
# - Status 400 Bad Request
# - Erro: OT finalizada n√£o pode ser editada

# ==============================================================================
# üîç 10. BUSCA E RELAT√ìRIOS
# ==============================================================================

### 10.1 Buscar OT por n√∫mero
GET {{otsURL}}/buscar/?numero_ot=OT20241206
Authorization: Bearer {{accessTokenLogistica}}
Content-Type: application/json

### 10.2 Buscar por cliente
GET {{otsURL}}/buscar/?cliente_nome=ABC
Authorization: Bearer {{accessTokenLogistica}}
Content-Type: application/json

### 10.3 Estat√≠sticas completas (log√≠stica)
GET {{otsURL}}/stats/
Authorization: Bearer {{accessTokenLogistica}}
Content-Type: application/json

# Esperado:
# - Estat√≠sticas gerais
# - Breakdown por status
# - Estat√≠sticas por motorista

### 10.4 Estat√≠sticas do motorista (filtradas)
GET {{otsURL}}/stats/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

# Esperado:
# - Apenas estat√≠sticas das OTs do Carlos
# - Sem dados de outros motoristas

# ==============================================================================
# üõ†Ô∏è 11. DEBUGGING E TROUBLESHOOTING
# ==============================================================================

### 11.1 Debug geral das OTs
GET {{otsURL}}/debug/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

### 11.2 Debug de OT espec√≠fica
GET {{otsURL}}/debug/{{otId}}/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

# ==============================================================================
# üö® 12. TESTES DE VALIDA√á√ÉO E ERRO
# ==============================================================================

### 12.1 Tentar criar OT sem dados obrigat√≥rios
POST {{otsURL}}/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

{
    "observacoes": "Apenas observa√ß√£o, sem dados obrigat√≥rios"
}

# Esperado: Status 400 Bad Request

### 12.2 Tentar transferir para motorista inexistente
POST {{otsURL}}/{{otId}}/transferir/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

{
    "motorista_destino_id": 99999,
    "motivo": "Teste com ID inv√°lido"
}

# Esperado: Status 400 Bad Request

### 12.3 Tentar aceitar transfer√™ncia que n√£o √© sua
POST {{otsURL}}/transferencias/{{transferenciaId}}/aceitar/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

{
    "observacao": "Tentando aceitar transfer√™ncia de outro"
}

# Esperado: Status 403 Forbidden

# ==============================================================================
# üìä 13. FLUXO COMPLETO DE CANCELAMENTO
# ==============================================================================

### 13.1 Criar transfer√™ncia para testar cancelamento
POST {{otsURL}}/NEW_OT_ID/transferir/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

{
    "motorista_destino_id": 2,
    "motivo": "Teste para cancelamento"
}

### 13.2 Cancelar transfer√™ncia (quem solicitou)
POST {{otsURL}}/transferencias/NEW_TRANSFER_ID/cancelar/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

{
    "observacao": "Mudan√ßa de planos - n√£o preciso mais transferir"
}

# Esperado:
# - Status 200 OK
# - Transfer√™ncia cancelada
# - OT continua com o motorista original

# ==============================================================================
# üì± 14. CASOS DE USO MOBILE
# ==============================================================================

### 14.1 Lista resumida para mobile (apenas status)
GET {{otsURL}}/?fields=id,numero_ot,status,cliente_nome
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

### 14.2 Atualiza√ß√£o r√°pida de localiza√ß√£o
PATCH {{otsURL}}/{{otId}}/
Authorization: Bearer {{accessTokenMotorista1}}
Content-Type: application/json

{
    "latitude_origem": -23.5510,
    "longitude_origem": -46.6340,
    "endereco_origem": "Atualiza√ß√£o GPS - Av. Paulista"
}

# ==============================================================================
# üìù NOTAS IMPORTANTES
# ==============================================================================

"""
üéØ PRINCIPAIS DIFEREN√áAS DO SISTEMA:

1. **TRANSFER√äNCIAS COM ACEITA√á√ÉO:**
   - Motorista ‚Üí Motorista: Aguarda aceita√ß√£o
   - Log√≠stica ‚Üí Qualquer: Aprovada diretamente
   - Outros ‚Üí Motorista: Aguarda aprova√ß√£o da log√≠stica

2. **FLUXOS DE STATUS:**
   - INICIADA ‚Üí EM_CARREGAMENTO ‚Üí EM_TRANSITO ‚Üí ENTREGUE
   - Estados finais: ENTREGUE, ENTREGUE_PARCIAL, CANCELADA

3. **PERMISS√ïES:**
   - Motoristas: apenas suas OTs
   - Log√≠stica: todas as OTs
   - Admin: todas as OTs + gerenciamento

4. **SISTEMA DE ACEITA√á√ÉO:**
   - GET /api/ots/transferencias/minhas/ (ver pendentes)
   - POST /api/ots/transferencias/{id}/aceitar/
   - POST /api/ots/transferencias/{id}/recusar/
   - POST /api/ots/transferencias/{id}/cancelar/

üö® LEMBRETE:
- Sempre substitua {{otId}} e {{transferenciaId}} pelos valores reais
- Copie tokens do login para as vari√°veis
- Execute na ordem sugerida para melhor experi√™ncia
- Use endpoints de debug para troubleshooting
"""