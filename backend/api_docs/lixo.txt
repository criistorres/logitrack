# ==============================================================================
# ğŸ“ VIEW DE REGISTRO - EXPLICAÃ‡ÃƒO PASSO A PASSO
# ==============================================================================

class RegisterView(APIView):
    """
    ğŸ¯ PROPÃ“SITO: Registrar novos usuÃ¡rios
    
    ğŸ“‹ FLUXO DESTA VIEW:
    1. Recebe dados JSON no request.data
    2. Cria UserRegistrationSerializer com esses dados
    3. Chama is_valid() â†’ dispara validates do serializer
    4. Se vÃ¡lido, chama save() â†’ dispara create() do serializer
    5. Gera tokens JWT
    6. Retorna resposta com dados do usuÃ¡rio e tokens
    
    ğŸ› DEBUGGING STEP-BY-STEP:
    1. Coloque breakpoint na linha: print("ğŸ¯ REGISTER VIEW: Iniciando registro")
    2. Coloque breakpoint na linha: serializer = UserRegistrationSerializer(data=request.data)
    3. Coloque breakpoint na linha: if serializer.is_valid():
    4. FaÃ§a requisiÃ§Ã£o POST para /api/auth/register/
    5. Siga o fluxo passo a passo
    """
    
    permission_classes = [permissions.AllowAny]  # Qualquer um pode se registrar

    def post(self, request):
        """
        Endpoint: POST /api/auth/register/
        
        Body JSON esperado:
        {
            "email": "usuario@example.com",
            "password": "minhasenha123",
            "password_confirm": "minhasenha123",
            "first_name": "JoÃ£o",
            "last_name": "Silva",
            "cpf": "12345678901",
            "phone": "11999999999",
            "role": "motorista"
        }
        """
        
        # ğŸ› BREAKPOINT 1: InÃ­cio da view
        print("ğŸ¯ REGISTER VIEW: Iniciando registro")
        print(f"ğŸ¯ Dados recebidos: {request.data}")
        print(f"ğŸ¯ MÃ©todo HTTP: {request.method}")
        print(f"ğŸ¯ Content-Type: {request.content_type}")
        
        logger.info(f"Tentativa de registro para: {request.data.get('email')}")
        
        # ğŸ› BREAKPOINT 2: CriaÃ§Ã£o do serializer
        print("ğŸ¯ Criando UserRegistrationSerializer...")
        serializer = UserRegistrationSerializer(data=request.data)
        
        # Debug do estado inicial do serializer
        debug_serializer_flow(serializer, "Serializer recÃ©m-criado")
        
        # ğŸ› BREAKPOINT 3: ValidaÃ§Ã£o (AQUI ENTRA NOS MÃ‰TODOS VALIDATE DO SERIALIZER!)
        print("ğŸ¯ Chamando serializer.is_valid()...")
        print("   â†³ Isso vai chamar os mÃ©todos validate_* do serializer")
        
        if serializer.is_valid():
            print("âœ… Dados vÃ¡lidos! Prosseguindo...")
            debug_serializer_flow(serializer, "ApÃ³s validaÃ§Ã£o bem-sucedida")
            
            # ğŸ› BREAKPOINT 4: Salvando (AQUI ENTRA NO CREATE DO SERIALIZER!)
            print("ğŸ¯ Chamando serializer.save()...")
            print("   â†³ Isso vai chamar o mÃ©todo create() do serializer")
            
            user = serializer.save()
            
            print(f"âœ… UsuÃ¡rio criado: {user.email} (ID: {user.id})")
            
            # ğŸ¯ Gerar tokens JWT
            print("ğŸ¯ Gerando tokens JWT...")
            refresh = RefreshToken.for_user(user)
            access_token = refresh.access_token
            
            print(f"âœ… Tokens gerados")
            print(f"   â†³ Access token: {str(access_token)[:20]}...")
            print(f"   â†³ Refresh token: {str(refresh)[:20]}...")
            
            # ğŸ¯ Preparar resposta
            response_data = {
                'success': True,
                'message': 'UsuÃ¡rio registrado com sucesso',
                'data': {
                    'user': UserProfileSerializer(user).data,
                    'tokens': {
                        'access': str(access_token),
                        'refresh': str(refresh)
                    }
                }
            }
            
            print("âœ… Registro concluÃ­do com sucesso!")
            return Response(response_data, status=status.HTTP_201_CREATED)
        
        else:
            # ğŸ› BREAKPOINT 5: Erros de validaÃ§Ã£o
            print("âŒ Dados invÃ¡lidos!")
            print(f"âŒ Erros: {serializer.errors}")
            debug_serializer_flow(serializer, "ApÃ³s validaÃ§Ã£o com erros")
            
            return Response({
                'success': False,
                'message': 'Dados invÃ¡lidos',
                'errors': serializer.errors
            }, status=status.HTTP_400_BAD_REQUEST)

            # ==============================================================================
# ğŸ› ï¸ SERIALIZER DE REGISTRO - PASSO A PASSO
# ==============================================================================

class UserRegistrationSerializer(serializers.ModelSerializer):
    """
    ğŸ“‹ PROPÃ“SITO: Registrar novos usuÃ¡rios no sistema
    
    ğŸ” DEBUGGING: Para acompanhar este serializer:
    
    1. Coloque breakpoint na linha 86: "def validate_email(self, value):"
    2. Coloque breakpoint na linha 105: "def validate_cpf(self, value):"
    3. Coloque breakpoint na linha 125: "def validate(self, attrs):"
    4. Coloque breakpoint na linha 151: "def create(self, validated_data):"
    5. FaÃ§a requisiÃ§Ã£o POST para /api/auth/register/
    6. Acompanhe a execuÃ§Ã£o seguindo a ordem acima
    
    ğŸ’¡ DICA: Os mÃ©todos validate_* sÃ£o chamados AUTOMATICAMENTE pelo DRF
    quando vocÃª chama serializer.is_valid()
    """
    
    # Campos extras que nÃ£o estÃ£o no model
    password = serializers.CharField(
        write_only=True,  # NÃ£o aparece na resposta JSON
        min_length=8,
        style={'input_type': 'password'}  # Para forms HTML
    )
    
    password_confirm = serializers.CharField(
        write_only=True,
        style={'input_type': 'password'}
    )

    class Meta:
        model = CustomUser
        fields = [
            'email', 'password', 'password_confirm', 
            'first_name', 'last_name', 'cpf', 'phone', 'role',
            'cnh_numero', 'cnh_categoria', 'cnh_validade'
        ]
        
        # Campos obrigatÃ³rios
        extra_kwargs = {
            'email': {'required': True},
            'cpf': {'required': True},
            'first_name': {'required': True},
            'last_name': {'required': True},
        }

    # ğŸ” MÃ‰TODO 1: ValidaÃ§Ã£o individual do email
    def validate_email(self, value):
        """
        âš¡ ESTE MÃ‰TODO Ã‰ CHAMADO AUTOMATICAMENTE!
        
        Quando vocÃª chama serializer.is_valid(), o DRF procura por mÃ©todos
        com o padrÃ£o validate_<nome_do_campo> e os executa automaticamente.
        
        ğŸ› DEBUGGING:
        - Coloque breakpoint AQUI na linha abaixo
        - FaÃ§a uma requisiÃ§Ã£o e veja como o mÃ©todo Ã© chamado
        """
        print(f"ğŸ” VALIDATE_EMAIL chamado com: {value}")
        print(f"ğŸ” Tipo do valor: {type(value)}")
        
        # Verificar se email jÃ¡ existe
        if CustomUser.objects.filter(email=value).exists():
            print(f"âŒ Email {value} jÃ¡ existe no banco!")
            raise serializers.ValidationError("Este email jÃ¡ estÃ¡ em uso.")
        
        print(f"âœ… Email {value} estÃ¡ disponÃ­vel")
        return value.lower()  # Retorna email em minÃºsculo

    # ğŸ” MÃ‰TODO 2: ValidaÃ§Ã£o individual do CPF
    def validate_cpf(self, value):
        """
        âš¡ TAMBÃ‰M Ã‰ CHAMADO AUTOMATICAMENTE!
        
        ğŸ› DEBUGGING: Coloque breakpoint aqui e observe:
        - Como o valor chega
        - Como Ã© processado
        - Como Ã© retornado
        """
        print(f"ğŸ” VALIDATE_CPF chamado com: {value}")
        
        # Limpar CPF (remover pontos e traÃ§os)
        cpf_limpo = ''.join(filter(str.isdigit, value))
        print(f"ğŸ” CPF apÃ³s limpeza: {cpf_limpo}")
        
        # Validar tamanho
        if len(cpf_limpo) != 11:
            print(f"âŒ CPF tem {len(cpf_limpo)} dÃ­gitos, precisa ter 11")
            raise serializers.ValidationError("CPF deve ter exatamente 11 dÃ­gitos.")
        
        # Verificar se jÃ¡ existe
        if CustomUser.objects.filter(cpf=cpf_limpo).exists():
            print(f"âŒ CPF {cpf_limpo} jÃ¡ existe no banco!")
            raise serializers.ValidationError("Este CPF jÃ¡ estÃ¡ cadastrado.")
        
        print(f"âœ… CPF {cpf_limpo} estÃ¡ vÃ¡lido")
        return cpf_limpo

    # ğŸ” MÃ‰TODO 3: ValidaÃ§Ã£o geral (todos os campos juntos)
    def validate(self, attrs):
        """
        âš¡ MÃ‰TODO ESPECIAL: Valida o objeto completo
        
        Este mÃ©todo Ã© chamado APÃ“S todos os validate_<campo> individuais.
        Aqui vocÃª pode validar regras que envolvem mÃºltiplos campos.
        
        ğŸ› DEBUGGING: 
        - Coloque breakpoint aqui
        - Inspecione a variÃ¡vel 'attrs'
        - Veja todos os dados validados juntos
        """
        print(f"ğŸ” VALIDATE geral chamado!")
        print(f"ğŸ” Dados recebidos: {attrs}")
        
        # Verificar se senhas coincidem
        password = attrs.get('password')
        password_confirm = attrs.get('password_confirm')
        
        print(f"ğŸ” Comparando senhas...")
        if password != password_confirm:
            print(f"âŒ Senhas nÃ£o coincidem!")
            raise serializers.ValidationError("As senhas nÃ£o coincidem.")
        
        # Validar forÃ§a da senha usando validadores do Django
        try:
            print(f"ğŸ” Validando forÃ§a da senha...")
            validate_password(password)
            print(f"âœ… Senha aprovada nos validadores Django")
        except ValidationError as e:
            print(f"âŒ Senha rejeitada: {e.messages}")
            raise serializers.ValidationError({"password": e.messages})
        
        # Remover confirmaÃ§Ã£o da senha (nÃ£o vamos salvÃ¡-la)
        attrs.pop('password_confirm', None)
        print(f"ğŸ” password_confirm removido dos dados")
        
        print(f"ğŸ” Dados finais validados: {attrs}")
        return attrs

    # ğŸ” MÃ‰TODO 4: CriaÃ§Ã£o do objeto
    def create(self, validated_data):
        """
        âš¡ MÃ‰TODO DE CRIAÃ‡ÃƒO: SÃ³ Ã© chamado quando vocÃª chama serializer.save()
        
        Recebe os dados jÃ¡ validados e limpos pelos mÃ©todos validate acima.
        
        ğŸ› DEBUGGING:
        - Coloque breakpoint aqui
        - Observe que validated_data jÃ¡ estÃ¡ limpo e validado
        - Acompanhe a criaÃ§Ã£o do usuÃ¡rio
        """
        print(f"ğŸ” CREATE chamado!")
        print(f"ğŸ” Dados validados recebidos: {validated_data}")
        
        # Extrair senha dos dados
        password = validated_data.pop('password')
        print(f"ğŸ” Senha extraÃ­da dos dados")
        
        # Criar usuÃ¡rio usando nosso manager customizado
        print(f"ğŸ” Criando usuÃ¡rio com CustomUserManager...")
        user = CustomUser.objects.create_user(
            password=password,
            **validated_data
        )
        
        print(f"âœ… UsuÃ¡rio criado com sucesso!")
        print(f"ğŸ” ID do usuÃ¡rio: {user.id}")
        print(f"ğŸ” Email do usuÃ¡rio: {user.email}")
        
        return user